name: Android CI

on:
  push:
    branches:
      - feature/android-skeleton
      - main
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    # Прокидываем secret в env на уровне job
    env:
      GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Prepare google-services.json
        # Условие уже по env, не по secrets
        if: ${{ env.GOOGLE_SERVICES_JSON_B64 != '' }}
        run: |
          set -euo pipefail
          mkdir -p app-android
          echo "${GOOGLE_SERVICES_JSON_B64}" | base64 -d > app-android/google-services.json

      - name: Export ANDROID_SDK_ROOT
        run: echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV

      - name: Verify no bidi chars in workflows
        run: '! grep -P "[\x{200E}\x{200F}\x{202A}-\x{202E}]" -R .github/workflows'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Verify Java toolchain
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version
          javac -version

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: ''

      - name: Provision SDK 35
        shell: bash
        run: |
          set -euo pipefail
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
          "platform-tools" \
          "platforms;android-35" \
          "build-tools;34.0.0" \
          "build-tools;35.0.0" \
          "cmdline-tools;latest"

            # Временное снятие pipefail только для лицензий
          set +o pipefail
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses
          set -o pipefail

      - name: Sanity SDK path
        run: |
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          test -d "$ANDROID_SDK_ROOT" || exit 1
          test "$ANDROID_SDK_ROOT" != "/android-sdk" || exit 1

      - name: Remove local.properties
        run: rm -f local.properties

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Detekt (release profile)
        run: ./gradlew -Ddetekt.config=config/detekt/detekt-release.yml detekt --info --no-daemon --stacktrace

      - name: Run checks and unit tests
        run: >-
          ./gradlew :core-domain:test :core-data:test :feature-exam:test
          test assembleDebug
          --no-daemon --stacktrace --info --console=plain --continue

      - name: Upload unit test report (core-data)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-data-testDebugUnitTest-report
          path: |
            core-data/build/reports/tests/testDebugUnitTest/
            core-data/build/test-results/testDebugUnitTest/

      - name: Publish unit test results (JUnit)
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit tests (JUnit)
          path: '**/build/test-results/**/TEST-*.xml'
          reporter: java-junit
          fail-on-error: 'false'

      - name: Generate coverage report
        run: ./gradlew koverXmlReport --no-daemon --stacktrace

      - name: Coverage gate
        run: ./gradlew koverVerify --no-daemon --stacktrace

      - name: Verify OSS licenses
        run: ./gradlew :app-android:licensee --no-daemon --stacktrace

      - name: Generate third-party notices
        run: ./gradlew generateThirdPartyNotices --no-daemon --stacktrace

      - name: Generate CycloneDX SBOM
        run: ./gradlew :app-android:cyclonedxBom --no-daemon --stacktrace

      - name: Build AAB (with Crashlytics symbol upload if google-services.json present)
        run: |
          if [ -f app-android/google-services.json ]; then
            echo "::notice::Building release AAB with Google Services (Crashlytics mapping upload enabled)"
            ./gradlew :app-android:bundleRelease -Pci=true -PwithGoogleServices=true --no-daemon --stacktrace
          else
            echo "::warning::Building release AAB without Google Services (no Crashlytics mapping upload)"
            ./gradlew :app-android:bundleRelease -Pci=true -PwithGoogleServices=false --no-daemon --stacktrace
          fi

      - name: Cleanup google-services.json
        if: always()
        run: rm -f app-android/google-services.json

      - name: Upload coverage XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kover-coverage-xml
          path: build/reports/kover/xml/report.xml

      - name: Upload debug APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qweld-debug-apk
          path: app-android/build/outputs/apk/debug/app-android-debug.apk

      - name: Upload compliance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oss-compliance
          path: |
            THIRD_PARTY_NOTICES.md
            **/build/reports/licensee/**
            **/build/reports/bom/**
