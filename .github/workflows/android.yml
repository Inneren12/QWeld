name: Android CI

on:
  push:
    branches:
      - feature/android-skeleton
      - main
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Wrapper validation (with retry) - replaces gradle/wrapper-validation-action@v2
      - name: Validate Gradle Wrapper
        id: wrapper_validation
        continue-on-error: true
        uses: gradle/actions/wrapper-validation@v4

      - name: Retry Validate Gradle Wrapper (once)
        id: wrapper_validation_retry
        if: steps.wrapper_validation.outcome == 'failure'
        continue-on-error: true
        uses: gradle/actions/wrapper-validation@v4

      - name: Fail if wrapper validation still failing
        if: steps.wrapper_validation.outcome == 'failure' && steps.wrapper_validation_retry.outcome == 'failure'
        run: exit 1

      - name: Prepare google-services.json
        if: ${{ env.GOOGLE_SERVICES_JSON_B64 != '' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p app-android
          echo "${GOOGLE_SERVICES_JSON_B64}" | base64 -d > app-android/google-services.json

      - name: Export ANDROID_SDK_ROOT
        shell: bash
        run: echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV

      - name: Verify no bidi chars in workflows
        shell: bash
        run: '! grep -P "[\x{200E}\x{200F}\x{202A}-\x{202E}]" -R .github/workflows'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Verify Java toolchain
        shell: bash
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version
          javac -version

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: ''

      - name: Provision SDK 35
        shell: bash
        run: |
          set -euo pipefail
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;34.0.0" \
            "build-tools;35.0.0" \
            "cmdline-tools;latest"

          # Temporarily disable pipefail for licenses
          set +o pipefail
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses
          set -o pipefail

      - name: Sanity SDK path
        shell: bash
        run: |
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          test -d "$ANDROID_SDK_ROOT" || exit 1
          test "$ANDROID_SDK_ROOT" != "/android-sdk" || exit 1

      - name: Remove local.properties
        shell: bash
        run: rm -f local.properties

      - name: Grant execute permission for gradlew
        shell: bash
        run: chmod +x gradlew

      - name: Detekt (release profile)
        shell: bash
        run: ./gradlew -Ddetekt.config=config/detekt/detekt-release.yml detekt --info --no-daemon --stacktrace

      # Run tests with explicit Android unit-test tasks to guarantee XML is produced
      - name: Run checks and unit tests
        shell: bash
        run: >-
          ./gradlew
          :core-domain:test
          :core-data:testDebugUnitTest
          :feature-exam:testDebugUnitTest
          test assembleDebug
          --no-daemon --stacktrace --info --console=plain --continue

      # Debug: show where Gradle actually produced XML/HTML reports
      - name: List JUnit XML (debug)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "JUnit XML files:"
          find . -path "*/build/test-results/*" -type f \( -name "*.xml" -o -name "TEST-*.xml" \) -print || true
          echo "Reports dirs:"
          find . -path "*/build/reports/tests/*" -maxdepth 2 -type d -print || true

      # Upload ALL unit test reports for offline inspection (HTML + XML)
      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: |
            **/build/reports/tests/**/*
            **/build/test-results/**/*
          if-no-files-found: warn

      # Show failing tests in the GitHub UI (Summary / Checks)
      - name: Publish unit test results (JUnit)
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit tests (JUnit)
          path: '**/build/test-results/**/**/*.xml'
          reporter: java-junit
          fail-on-error: 'false'

      - name: Generate coverage report
        shell: bash
        run: ./gradlew koverXmlReport --no-daemon --stacktrace

      - name: Coverage gate
        shell: bash
        run: ./gradlew koverVerify --no-daemon --stacktrace

      - name: Verify OSS licenses
        shell: bash
        run: ./gradlew :app-android:licensee --no-daemon --stacktrace

      - name: Generate third-party notices
        shell: bash
        run: ./gradlew generateThirdPartyNotices --no-daemon --stacktrace

      - name: Generate CycloneDX SBOM
        shell: bash
        run: ./gradlew :app-android:cyclonedxBom --no-daemon --stacktrace

      - name: Build AAB (with Crashlytics symbol upload if google-services.json present)
        shell: bash
        run: |
          if [ -f app-android/google-services.json ]; then
            echo "::notice::Building release AAB with Google Services (Crashlytics mapping upload enabled)"
            ./gradlew :app-android:bundleRelease -Pci=true -PwithGoogleServices=true --no-daemon --stacktrace
          else
            echo "::warning::Building release AAB without Google Services (no Crashlytics mapping upload)"
            ./gradlew :app-android:bundleRelease -Pci=true -PwithGoogleServices=false --no-daemon --stacktrace
          fi

      - name: Cleanup google-services.json
        if: always()
        shell: bash
        run: rm -f app-android/google-services.json

      - name: Upload coverage XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kover-coverage-xml
          path: build/reports/kover/xml/report.xml
          if-no-files-found: warn

      - name: Upload debug APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qweld-debug-apk
          path: app-android/build/outputs/apk/debug/app-android-debug.apk
          if-no-files-found: warn

      - name: Upload compliance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oss-compliance
          path: |
            THIRD_PARTY_NOTICES.md
            **/build/reports/licensee/**
            **/build/reports/bom/**
          if-no-files-found: warn
