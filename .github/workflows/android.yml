name: Android CI

on:
    push:
        branches:
            - feature/android-skeleton
            - main
    pull_request:
        branches:
            - '*'

jobs:
    build:
        runs-on: ubuntu-latest
        env:
            ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: '21'

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v3

            - name: Install Android SDK
              run: |
                  set -euo pipefail
                  mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
                  cd "$ANDROID_SDK_ROOT"
                  curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdline-tools.zip
                  unzip -q cmdline-tools.zip
                  rm cmdline-tools.zip
                  mv cmdline-tools cmdline-tools-temp
                  mkdir -p cmdline-tools/latest
                  mv cmdline-tools-temp/* cmdline-tools/latest/
                  rm -rf cmdline-tools-temp
                  export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
                  echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
                  echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"
                  COMPILE_SDK=$(grep -Rho "compileSdk *[0-9][0-9]" . | tail -n1 | grep -o "[0-9]*")
                  BUILD_TOOLS=$(grep -Rho "buildToolsVersion *\"[0-9.]*\"" . | head -n1 | grep -o "[0-9.]*" || true)
                  yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-${COMPILE_SDK}"
                  if [ -n "$BUILD_TOOLS" ]; then
                      yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "build-tools;${BUILD_TOOLS}"
                  fi
                  yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses
                  cd "$GITHUB_WORKSPACE"

            - name: Remove local.properties
              run: rm -f local.properties

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Run checks and unit tests
              run: >-
                  ./gradlew spotlessCheck detekt :core-domain:test :core-data:test :feature-exam:test
                  test assembleDebug --no-daemon --stacktrace

            - name: Generate coverage report
              run: ./gradlew koverXmlReport --no-daemon --stacktrace

            - name: Enforce coverage threshold
              env:
                  THRESH: '0.60'
              run: bash scripts/coverage-threshold.sh

            - name: Verify OSS licenses
              run: ./gradlew :app-android:licensee --no-daemon --stacktrace

            - name: Generate third-party notices
              run: ./gradlew generateThirdPartyNotices --no-daemon --stacktrace

            - name: Generate CycloneDX SBOM
              run: ./gradlew :app-android:cyclonedxBom --no-daemon --stacktrace

            - name: Upload coverage XML
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: kover-coverage-xml
                  path: build/reports/kover/xml/report.xml

            - name: Upload debug APK
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: qweld-debug-apk
                  path: app-android/build/outputs/apk/debug/app-android-debug.apk

            - name: Upload compliance artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: oss-compliance
                  path: |
                      THIRD_PARTY_NOTICES.md
                      **/build/reports/licensee/**
                      **/build/reports/bom/**
