name: Android CI

on:
    push:
        branches:
            - feature/android-skeleton
            - main
    pull_request:
        branches:
            - '*'

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Export ANDROID_SDK_ROOT
              run: echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV
            - name: Checkout
              uses: actions/checkout@v4
            - name: Sanity SDK path
              run: |
                  echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
                  test -n "$ANDROID_SDK_ROOT"
                  test -d "$RUNNER_TEMP"
                  test "$ANDROID_SDK_ROOT" != "/android-sdk"
            - name: Verify no bidi chars in workflows
              run: '! grep -P "[\x{200E}\x{200F}\x{202A}-\x{202E}]" -R .github/workflows'

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: '21'

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v3

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3
              with:
                  packages: ''  # Add packages such as 'platform-tools;build-tools-35.0.0;platforms;android-35' if required

            - name: Remove local.properties
              run: rm -f local.properties

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Detekt (release profile)
              run: ./gradlew -Ddetekt.config=config/detekt/detekt-release.yml detekt --info --no-daemon --stacktrace

            - name: Run checks and unit tests
              run: >-
                  ./gradlew :core-domain:test :core-data:test :feature-exam:test
                  test assembleDebug --no-daemon --stacktrace

            - name: Generate coverage report
              run: ./gradlew koverXmlReport --no-daemon --stacktrace

            - name: Coverage gate
              run: ./gradlew koverVerify --no-daemon --stacktrace

            - name: Verify OSS licenses
              run: ./gradlew :app-android:licensee --no-daemon --stacktrace

            - name: Generate third-party notices
              run: ./gradlew generateThirdPartyNotices --no-daemon --stacktrace

            - name: Generate CycloneDX SBOM
              run: ./gradlew :app-android:cyclonedxBom --no-daemon --stacktrace

            - name: Upload coverage XML
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: kover-coverage-xml
                  path: build/reports/kover/xml/report.xml

            - name: Upload debug APK
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: qweld-debug-apk
                  path: app-android/build/outputs/apk/debug/app-android-debug.apk

            - name: Upload compliance artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: oss-compliance
                  path: |
                      THIRD_PARTY_NOTICES.md
                      **/build/reports/licensee/**
                      **/build/reports/bom/**
