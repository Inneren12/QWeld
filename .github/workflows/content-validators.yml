name: content-validators
on:
  pull_request:
    paths:
      - "assets/blueprints/**"
      - "app-android/src/main/assets/questions/**"
      - "tools/schema-validation/**"
  workflow_dispatch:

jobs:
  validate-blueprint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Install validator deps
        working-directory: tools/schema-validation
        run: npm ci

      - name: Debug root questions/index.json (what AJV actually sees)
        working-directory: tools/schema-validation
        shell: bash
        run: |
          set -euo pipefail
          echo "CI SHA: $(git rev-parse HEAD)"
          ls -la ../../app-android/src/main/assets/questions
          echo "--- head of questions/index.json ---"
          sed -n '1,40p' ../../app-android/src/main/assets/questions/index.json
          echo "--- types ---"
          node -e "const fs=require('fs');const p='../../app-android/src/main/assets/questions/index.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));const t=v=>Array.isArray(v)?'array':(v===null?'null':typeof v);console.log('en.tasks',t(j.locales?.en?.tasks),'en.sha256',t(j.locales?.en?.sha256));console.log('ru.tasks',t(j.locales?.ru?.tasks),'ru.sha256',t(j.locales?.ru?.sha256));"

      - name: Debug root questions/index.json (what AJV actually sees)
        working-directory: tools/schema-validation
        shell: bash
        run: |
          set -euo pipefail
          echo "CI SHA: $(git rev-parse HEAD)"
          ls -la ../../app-android/src/main/assets/questions
          echo "--- head of questions/index.json ---"
          sed -n '1,40p' ../../app-android/src/main/assets/questions/index.json
          echo "--- types ---"
          node -e "const fs=require('fs');const p='../../app-android/src/main/assets/questions/index.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));const t=v=>Array.isArray(v)?'array':(v===null?'null':typeof v);console.log('en.tasks',t(j.locales?.en?.tasks),'en.sha256',t(j.locales?.en?.sha256));console.log('ru.tasks',t(j.locales?.ru?.tasks),'ru.sha256',t(j.locales?.ru?.sha256));"

      - name: Debug questions root index shape (what Ajv will read)
        working-directory: tools/schema-validation
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          echo "List questions dir:"
          ls -la ../../app-android/src/main/assets/questions || true
          echo "Print types from root questions/index.json:"
          node - <<'NODE'
          const fs = require('fs');
          const p = '../../app-android/src/main/assets/questions/index.json';
          const txt = fs.readFileSync(p, 'utf8');
          const j = JSON.parse(txt);
          const t = (v) => Array.isArray(v) ? 'array' : (v === null ? 'null' : typeof v);
          const en = j.locales?.en;
          const ru = j.locales?.ru;
          console.log('schema=', j.schema, 'generatedAt=', j.generatedAt);
          console.log('en.tasks=', t(en?.tasks), 'en.sha256=', t(en?.sha256));
          console.log('ru.tasks=', t(ru?.tasks), 'ru.sha256=', t(ru?.sha256));
          console.log('raw "tasks": occurrences=', (txt.match(/"tasks"\\s*:/g) || []).length);
          console.log('raw "sha256": occurrences=', (txt.match(/"sha256"\\s*:/g) || []).length);
          NODE

      - name: Validate index.json via Ajv
        working-directory: tools/schema-validation
        run: |
          # Validate ROOT index separately for clearer logs
          npx -y ajv-cli@5 validate \
            -c ajv-formats \
            -s schemas/welder_blueprint.schema.json \
            -d "../../app-android/src/main/assets/questions/index.json" \
            --spec=draft2020 --all-errors --strict=false

          # Validate per-locale manifests (exclude root)
          npx -y ajv-cli@5 validate \
            -c ajv-formats \
            -s schemas/welder_blueprint.schema.json \
            -d "../../app-android/src/main/assets/questions/*/index.json" \
            --spec=draft2020 --all-errors --strict=false
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle
      # RU locale coverage gate: fails if overall RU coverage drops below the configured threshold.
      # Raise localeCoverage.ru.min as translation coverage improves.
      - name: Run RU locale coverage test
        env:
          ANDROID_HOME: /usr/local/lib/android/sdk
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: ./gradlew :feature-exam:testDebugUnitTest -PlocaleCoverage.ru.min=0.90 --tests com.qweld.app.feature.exam.data.LocaleCoverageTest
      - name: Upload Ajv logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ajv-logs
          path: .
