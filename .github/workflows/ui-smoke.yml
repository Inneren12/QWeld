name: Android UI smoke

on:
    push:
        branches:
            - main
            - feature/android-skeleton
            - feature/f8-hardening
    pull_request:
        branches:
            - '*'

jobs:
    ui-smoke:
        runs-on: ubuntu-latest
        continue-on-error: true
        timeout-minutes: 45
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            # Создаём google-services.json только при наличии секрета.
            # Проверка выполняется внутри bash, чтобы избежать ошибок валидатора GitHub Actions.
            - name: Prepare google-services.json (optional)
              shell: bash
              env:
                  GS_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
              run: |
                  set -euo pipefail
                  if [ -n "${GS_B64}" ]; then
                      mkdir -p app-android
                      echo "${GS_B64}" | base64 -d > app-android/google-services.json
                      echo "google-services.json created"
                  else
                      echo "No GOOGLE_SERVICES_JSON_B64 secret. Skipping."
                  fi
            - name: Export ANDROID_SDK_ROOT
              run: echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV
            - name: Guard ANDROID_SDK_ROOT is resolvable
              run: |
                  echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
                  test -d "$RUNNER_TEMP"
                  test "$ANDROID_SDK_ROOT" != "/android-sdk"
            - name: Verify no bidi chars in workflows
              run: '! grep -P "[\x{200E}\x{200F}\x{202A}-\x{202E}]" -R .github/workflows'

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: '21'

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v3

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3
              with:
                  packages: ''

            - name: Remove local.properties
              run: rm -f local.properties

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Run UI smoke tests
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: 36
                  system-image-api-level: 34
                  target: google_apis
                  arch: x86_64
                  profile: pixel_6
                  emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
                  script: ./gradlew :app-android:assembleDebug :app-android:assembleDebugAndroidTest connectedDebugAndroidTest -x lint -x test --no-daemon --stacktrace
