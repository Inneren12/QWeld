name: Android UI smoke

on:
    push:
        branches:
            - main
            - feature/android-skeleton
            - feature/f8-hardening
    pull_request:
        branches:
            - '*'

jobs:
    ui-smoke:
        runs-on: ubuntu-latest
        continue-on-error: true
        timeout-minutes: 45
        strategy:
            matrix:
                api: [34, 35]
                device: [pixel_6]

        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Export ANDROID_SDK_ROOT
              run: echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV
            - name: Guard ANDROID_SDK_ROOT is resolvable
              run: |
                  echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
                  test -n "$ANDROID_SDK_ROOT"
                  test "$ANDROID_SDK_ROOT" != "/android-sdk"
            - name: Verify no bidi chars in workflows
              run: '! grep -P "[\x{200E}\x{200F}\x{202A}-\x{202E}]" -R .github/workflows'

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: '21'

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v3

            - uses: android-actions/setup-android@v3

            - name: Install Android SDK packages (compileSdk & build-tools)
              shell: bash
              run: |
                  set -euo pipefail
                  # autodetect from Gradle (fallbacks: api 34/35 and build-tools 34.0.0)
                  COMPILE_SDK="$(grep -Rho 'compileSdk *[0-9]\{2\}' . | head -n1 | grep -o '[0-9]\{2\}' || true)"
                  BUILD_TOOLS="$(grep -Rho 'buildToolsVersion *\"[0-9\.]\+\"' . | head -n1 | grep -o '[0-9\.]\+' || true)"
                  echo "[sdk] compileSdk=${COMPILE_SDK:-<none>} buildTools=${BUILD_TOOLS:-<none>}"

                  sdkmanager "platform-tools" >/dev/null

                  if [ -n "${COMPILE_SDK:-}" ]; then
                      sdkmanager "platforms;android-${COMPILE_SDK}" >/dev/null
                  else
                      # попробуем обе целевые конфигурации smoke (34 и 35)
                      sdkmanager "platforms;android-34" "platforms;android-35" >/dev/null
                  fi

                  if [ -n "${BUILD_TOOLS:-}" ]; then
                      sdkmanager "build-tools;${BUILD_TOOLS}" >/dev/null
                  else
                      sdkmanager "build-tools;34.0.0" >/dev/null
                  fi

                  # главное: принять лицензии БЕЗ диалога
                  yes | sdkmanager --licenses >/dev/null

            - name: Remove local.properties
              run: rm -f local.properties

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Assemble debug and androidTest APKs
              run: ./gradlew :app-android:assembleDebug :app-android:assembleDebugAndroidTest --no-daemon --stacktrace

            - name: Run UI smoke tests (connectedDebugAndroidTest)
              uses: ReactiveCircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api }}
                  arch: x86_64
                  target: google_apis
                  profile: ${{ matrix.device }}
                  script: ./gradlew :app-android:connectedDebugAndroidTest --no-daemon --stacktrace
