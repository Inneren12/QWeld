{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Welder content schema",
  "description": "Shared schema for blueprint documents and generated question bundles",
  "anyOf": [
    { "$ref": "#/$defs/rootIndex" },
    { "$ref": "#/$defs/localeBundle" },
    { "$ref": "#/$defs/blueprint" }
  ],
  "$defs": {
    "sha256": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$"
    },
    "taskCount": {
      "type": "integer",
      "minimum": 0
    },
    "taskHash": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sha256"],
      "properties": {
        "sha256": { "$ref": "#/$defs/sha256" }
      }
    },
    "taskCountMap": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        "^[A-D]-\\d+$": { "$ref": "#/$defs/taskCount" }
      },
      "additionalProperties": false
    },
    "taskHashMap": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        "^[A-D]-\\d+$": { "$ref": "#/$defs/sha256" }
      },
      "additionalProperties": false
    },
    "localeEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["total", "tasks", "sha256"],
      "properties": {
        "total": { "$ref": "#/$defs/taskCount" },
        "tasks": { "$ref": "#/$defs/taskCountMap" },
        "sha256": {
          "type": "object",
          "additionalProperties": false,
          "required": ["bank", "tasks"],
          "properties": {
            "bank": { "$ref": "#/$defs/sha256" },
            "tasks": { "$ref": "#/$defs/taskHashMap" }
          }
        }
      }
    },
    "rootIndex": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema", "generatedAt", "locales"],
      "properties": {
        "schema": {
          "type": "string",
          "const": "questions-index-v1"
        },
        "generatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "locales": {
          "type": "object",
          "minProperties": 1,
          "patternProperties": {
            "^[a-z]{2}$": { "$ref": "#/$defs/localeEntry" }
          },
          "additionalProperties": false
        }
      }
    },
    "localeBundle": {
      "type": "object",
      "additionalProperties": false,
      "required": ["blueprintId", "bankVersion", "files"],
      "properties": {
        "blueprintId": {
          "type": "string",
          "pattern": "^welder_ip_[a-z]{2}_[0-9]{6}$"
        },
        "bankVersion": {
          "type": "string",
          "minLength": 1
        },
        "files": {
          "type": "object",
          "minProperties": 1,
          "patternProperties": {
            "^questions/[a-z]{2}/.+\\.json$": { "$ref": "#/$defs/taskHash" }
          },
          "additionalProperties": false
        }
      }
    },
    "blueprintTask": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "quota"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[A-D]-\\d+$"
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "quota": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "blueprintBlock": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "tasks"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[A-D]$"
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "tasks": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/blueprintTask" }
        }
      }
    },
    "blueprint": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "trade",
        "exam",
        "blueprintVersion",
        "policyVersion",
        "questionCount",
        "validFrom",
        "sources",
        "blocks"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^welder_ip_[a-z]{2}_[0-9]{6}$"
        },
        "trade": {
          "type": "string",
          "const": "Welder"
        },
        "exam": {
          "type": "string",
          "const": "Interprovincial Red Seal"
        },
        "blueprintVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "policyVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+$"
        },
        "questionCount": {
          "type": "integer",
          "minimum": 1
        },
        "validFrom": {
          "type": "string",
          "format": "date"
        },
        "sources": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "name", "notes"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["primary", "historical", "reference"]
              },
              "name": {
                "type": "string",
                "minLength": 1
              },
              "notes": {
                "type": "string",
                "minLength": 1
              }
            }
          }
        },
        "blocks": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/blueprintBlock" }
        }
      }
    }
  }
}
